<?php

namespace App\Http\Controllers;

use App\Models\ScorePenalty;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;

class VulnerabilityAreaController extends Controller
{
    public function index(): JsonResponse
    {
        $penalties = ScorePenalty::query()
            ->where('category', 'vulnerability')
            ->where('is_active', true)
            ->get()
            ->keyBy('slug');

        $areas = DB::table('vulnerability_areas')
            ->where('is_current', true)
            ->select(
                'id',
                'name',
                'tier',
                'police_region',
                'municipality_name',
                DB::raw('ST_AsGeoJSON(ST_SimplifyPreserveTopology(geom, 0.0001)) as geojson')
            )
            ->get()
            ->map(function ($area) use ($penalties) {
                $penaltySlug = 'vuln_'.$area->tier;
                $penalty = $penalties->get($penaltySlug);

                return [
                    'id' => $area->id,
                    'name' => $area->name,
                    'tier' => $area->tier,
                    'tier_label' => match ($area->tier) {
                        'sarskilt_utsatt' => 'Särskilt utsatt område',
                        'utsatt' => 'Utsatt område',
                        default => $area->tier,
                    },
                    'police_region' => $area->police_region,
                    'municipality' => $area->municipality_name,
                    'penalty_points' => $penalty?->penalty_value,
                    'color' => $penalty?->color ?? '#ef4444',
                    'border_color' => $penalty?->border_color ?? '#991b1b',
                    'opacity' => (float) ($penalty?->opacity ?? 0.15),
                    'geojson' => json_decode($area->geojson),
                ];
            });

        return response()->json($areas)
            ->header('Cache-Control', 'public, max-age=86400');
    }
}
