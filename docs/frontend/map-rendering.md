# Map Rendering

> OpenLayers map with pre-rendered heatmap tiles and pin-drop location scoring.

## Component: `HeatmapMap`

**File**: `resources/js/components/deso-map.tsx`

A `forwardRef` component exposing an imperative handle (`HeatmapMapHandle`) for parent control. The map uses pre-rendered heatmap PNG tiles as the primary visualization instead of client-side polygon rendering.

## Layer Stack

| Layer | Type | Z-Index | Purpose |
|---|---|---|---|
| Basemap | `TileLayer` | 0 | CARTO / OSM / Esri satellite |
| Country Mask | `VectorLayer` | 1 | Dims areas outside Sweden (semi-transparent white) |
| Sweden Border | `VectorLayer` | 2 | Dashed border stroke around Sweden |
| Heatmap Tiles | `TileLayer` (XYZ) | 3 | Pre-rendered score heatmap from `/tiles/{year}/{z}/{x}/{y}.png` |
| Radius Circle | `VectorLayer` | 4 | 3 km dashed circle around dropped pin |
| POI Markers | `VectorLayer` | 8 | Category-colored POI icons (from pin lookup) |
| School Markers | `VectorLayer` | 10 | Merit-colored school markers (from pin lookup) |
| Pin Marker | `VectorLayer` | 50 | White circle with dark border at clicked location |

## Heatmap Tile Layer

The main visualization uses **pre-rendered PNG tiles** instead of client-side polygon/hexagon rendering:

```typescript
const heatmapLayer = new TileLayer({
    source: new XYZ({
        url: '/tiles/2025/{z}/{x}/{y}.png',
        minZoom: 5,
        maxZoom: 12,
    }),
    opacity: 0.45,
    zIndex: 3,
});
```

Tiles are generated by a Python script (`scripts/generate_heatmap_tiles.py`) from H3 scores with Gaussian blur for smooth gradients. See [Heatmap Tiles](/api/heatmap-tiles) for generation details.

### Zoom-Dependent Opacity

Heatmap opacity decreases at higher zoom so underlying basemap details remain visible:

| Zoom | Opacity |
|---|---|
| < 12 | 0.45 |
| 12 | 0.30 |
| 13+ | 0.20 |

## Country Mask

The map loads `sweden-boundary.geojson` on init and renders a semi-transparent white polygon covering everything **except** Sweden. This creates a "spotlight" effect that focuses attention on Swedish territory.

The Sweden border is drawn as a separate dashed-line layer on top.

## Basemap Options

Three basemap types are available via the `BasemapControl` widget (top-right):

| Basemap | Source | Best For |
|---|---|---|
| Clean | CARTO Light | Score overlay readability |
| Detailed | OpenStreetMap | Street-level navigation |
| Satellite | Esri World Imagery | Physical context |

## Interactions

### Click → Pin Drop

Any click on the map within Sweden's bounds drops a pin and triggers a location lookup:

1. Pin placed as white circle with dark border
2. 3 km radius circle drawn (dashed, semi-transparent)
3. `onPinDrop(lat, lng)` callback fires → parent fetches `/api/location/{lat},{lng}`
4. School markers and POI markers appear from the API response
5. Map zooms to level 14 centered on the pin

### Hover Tooltips

An OpenLayers `Overlay` shows tooltips on hover:

- **School marker**: School name + merit value
- **POI marker**: POI name + category
- **POI cluster**: Count with positive/negative/neutral breakdown

## Color Scale

Five-stop gradient from purple (0) to green (100), consistent across heatmap tiles and UI:

| Score | Color | Hex |
|---|---|---|
| 0 | Deep purple | `#4a0072` |
| 25 | Red-purple | `#9c1d6e` |
| 50 | Yellow | `#f0c040` |
| 75 | Light green | `#6abf4b` |
| 100 | Deep green | `#1a7a2e` |

## Imperative Handle

The parent `map.tsx` page controls the map via ref:

| Method | Purpose |
|---|---|
| `updateSize()` | Recalculate map size after layout change |
| `dropPin(lat, lng)` | Place pin marker at coordinate |
| `clearPin()` | Remove pin, school markers, POI markers, radius circle |
| `setSchoolMarkers(schools)` | Render merit-colored school icons |
| `clearSchoolMarkers()` | Remove all school markers |
| `setRadiusCircle(lat, lng, meters)` | Draw dashed radius circle |
| `setPoiMarkers(pois, categories)` | Render category-colored POI icons |
| `clearPoiMarkers()` | Remove all POI markers |
| `zoomToPoint(lat, lng, zoom)` | Animated zoom to location |
| `zoomToExtent(w, s, e, n)` | Fit view to bounding box |
| `getMap()` | Access underlying OpenLayers `Map` instance |

## UI Overlays

- **Score Legend**: Bottom-left gradient bar (purple to green) with "High Risk" / "Strong" labels
- **Basemap Control**: Top-right radio buttons (Clean / Detailed / Satellite)

## Related

- [Heatmap Tiles](/api/heatmap-tiles)
- [Location Lookup API](/api/location-lookup)
- [Sidebar](/frontend/sidebar)
