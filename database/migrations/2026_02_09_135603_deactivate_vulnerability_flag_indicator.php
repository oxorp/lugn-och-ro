<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    public function up(): void
    {
        $now = now();

        // Deactivate vulnerability_flag — replaced by hard penalty system
        DB::table('indicators')
            ->where('slug', 'vulnerability_flag')
            ->update([
                'is_active' => false,
                'weight' => 0,
                'direction' => 'neutral',
                'description' => 'DEPRECATED — replaced by hard penalty system. See score_penalties table.',
                'updated_at' => $now,
            ]);

        // Redistribute weight to other safety indicators
        $weightUpdates = [
            'crime_violent_rate' => 0.0800,
            'crime_property_rate' => 0.0550,
            'perceived_safety' => 0.0600,
        ];

        foreach ($weightUpdates as $slug => $weight) {
            DB::table('indicators')
                ->where('slug', $slug)
                ->update(['weight' => $weight, 'updated_at' => $now]);
        }
    }

    public function down(): void
    {
        $now = now();

        // Reactivate vulnerability_flag
        DB::table('indicators')
            ->where('slug', 'vulnerability_flag')
            ->update([
                'is_active' => true,
                'weight' => 0.1000,
                'direction' => 'negative',
                'description' => 'Polisen classification: 0=not flagged, 1=utsatt, 2=särskilt utsatt',
                'updated_at' => $now,
            ]);

        // Restore original weights
        $weightUpdates = [
            'crime_violent_rate' => 0.0600,
            'crime_property_rate' => 0.0450,
            'perceived_safety' => 0.0450,
        ];

        foreach ($weightUpdates as $slug => $weight) {
            DB::table('indicators')
                ->where('slug', $slug)
                ->update(['weight' => $weight, 'updated_at' => $now]);
        }
    }
};
